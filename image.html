<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>画像お題 | RxD Base</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="noindex, nofollow">
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    :root{
      --bg:#F5EBFA; --ink:#222; --card:#fff; --pink:#FF93C2; --mint:#7FE7DB; --sun:#FFF59F; --ink2:#555; --line:#DDD;
      --thumb: 112px;            /* ← サムネの大きさはここで一括調整 */
      --thumb-radius: 12px;
      --target-accent: var(--mint);
    }
    html{ background:var(--bg); color:var(--ink);
      font-family:'Noto Sans JP','Kosugi Maru','M PLUS Rounded 1c',system-ui,sans-serif; }
    body{ margin:0; min-height:100vh; scroll-behavior:smooth; }
    .container{ max-width:780px; margin:0 auto; padding:24px 12px 56px; }
    .logoimg{ width:56px; height:56px; border-radius:50%; display:block; margin:0 auto 8px; }
    h1{ margin:0 0 12px; font-size:1.9rem; font-weight:800; letter-spacing:.03em; text-align:center; }
    hr.cute{ border:none; border-top:2.5px dashed var(--pink); margin:18px auto 26px; width:90%; }
    .desc{ text-align:center; font-size:1.06rem; color:var(--ink2); margin-bottom:20px; }

    .cards{ display:grid; grid-template-columns:1fr; gap:20px; }

    .card{
      background:var(--card);
      border:2.5px solid var(--pink);
      border-radius:16px;
      box-shadow:0 2px 12px #7FE7DB20;
      padding:16px;
      display:flex; align-items:flex-start; gap:14px;
      transition:box-shadow .18s, border-color .18s, background .18s;
      position:relative; scroll-margin-top:16px;
    }
    .card:hover{ box-shadow:0 4px 24px #FF93C288; border-color:var(--mint); }

    /* 画像側の縦レイアウト（共有バー→サムネ） */
    .media{
      display:flex; flex-direction:column; gap:6px; align-items:flex-start; flex:0 0 auto;
    }

    /* 共有バー（常に画像の上に表示） */
    .sharebar{ display:flex; gap:6px; }
    .sharebtn{
      border:none; border-radius:8px; padding:2px 8px; font-size:0.75rem; font-weight:bold;
      cursor:pointer; transition:background .18s, opacity .18s; line-height:1.8;
    }
    .urlbtn{ background:var(--sun); color:#555; }
    .urlbtn:hover{ background:var(--pink); color:#fff; }
    .xbtn{ background:#111; color:#fff; opacity:.9; }
    .xbtn:hover{ background:#000; opacity:1; }
    .sysbtn{ background:var(--mint); color:#222; }
    .sysbtn:hover{ background:var(--pink); color:#fff; }
    .sharebtn[disabled]{ opacity:.6; cursor:default; }

    .thumb{
      width:var(--thumb); height:var(--thumb);
      border-radius:var(--thumb-radius); object-fit:cover;
      border:2px solid var(--sun); background:#f3f2f9;
      cursor:zoom-in;
    }
    /* 読み込み中の骨組み（キラッと） */
    .thumb.skel{ position:relative; overflow:hidden; border-style:dashed; }
    .thumb.skel::after{
      content:""; position:absolute; inset:0;
      background:linear-gradient(90deg, transparent, #ffffff55, transparent);
      animation:shimmer 1.1s infinite;
    }
    @keyframes shimmer{ from{ transform:translateX(-100%);} to{ transform:translateX(100%);} }

    .thumb.ph{
      display:flex; align-items:center; justify-content:center;
      font-size:.72rem; color:#999; background:#f3f2f9; border-style:dashed;
      cursor:default; width:var(--thumb); height:var(--thumb); border-radius:var(--thumb-radius);
    }

    .cardbody{ flex:1 1 auto; min-width:0; }
    .cardtitle{ font-size:1.12rem; font-weight:800; color:#FF93C2; margin-bottom:2px; }
    .carddesc{ font-size:1rem; color:#555; margin-bottom:8px; }

    .promptbox{ display:flex; align-items:center; gap:8px; width:100%; }
    .promptarea{
      background:#F8F7FD; border:1.5px solid var(--line); border-radius:8px;
      font-size:.95rem; color:#444; letter-spacing:.01em;
      height:28px; line-height:28px; padding:0 8px;
      resize:none; overflow:hidden; white-space:nowrap;
      flex:1 1 260px; min-width:0; max-width:100%;
    }
    .copybtn{
      background:var(--mint); color:var(--ink); font-weight:800; border:none; border-radius:10px;
      padding:8px 12px; cursor:pointer; transition:background .18s, transform .06s;
      font-size:.95rem; flex:0 0 auto;
    }
    .copybtn:hover{ background:var(--pink); color:#fff; }
    .copybtn:active{ transform:translateY(1px); }
    .copybtn[disabled]{ opacity:.7; cursor:default; }

    .footer{ text-align:center; margin-top:40px; color:#B3A9D6; font-size:.96rem; }

    .toplink, .backlink{
      display:inline-block; background:var(--mint); color:var(--ink); font-weight:bold;
      text-decoration:none; border-radius:8px; padding:6px 14px; margin:12px auto; transition:background .18s;
    }
    .toplink:hover, .backlink:hover{ background:var(--pink); color:#fff; }

    .gotop{ position:absolute; top:8px; right:12px; font-size:0.9rem; text-decoration:none; color:#777; }
    .gotop:hover{ color:#FF93C2; }

    /* #ID 一致カードの強調 */
    .card.is-target{
      background:linear-gradient(180deg,#fff 0%, #fff6fb 55%, #fff 100%);
      border-color:var(--target-accent);
      box-shadow:0 0 0 3px #7FE7DB66, 0 8px 28px #FF93C244;
    }
    .card.is-target .cardtitle{ color:var(--target-accent); }

    @media (max-width:600px){
      .container{ padding:14px 8px 36px; }
      .thumb{ width:calc(var(--thumb) - 18px); height:calc(var(--thumb) - 18px); border-radius:10px; }
      .card{ padding:12px; gap:10px; }
      .cardtitle{ font-size:1.06rem; }
      .promptbox{ gap:6px; }
      .promptarea{ flex:1 1 140px; }
      .copybtn{ padding:8px 10px; font-size:.92rem; }
    }

    @media (prefers-reduced-motion:reduce){ *{ transition:none !important; animation:none !important; } }

    .highlight { animation: flash 1.8s ease; }
    @keyframes flash {
      0% { box-shadow:0 0 0 #FF93C200; }
      30% { box-shadow:0 0 18px #FF93C288; }
      100% { box-shadow:0 0 0 #FF93C200; }
    }

    /* ライトボックス */
    .lightbox[hidden]{ display:none; }
    .lightbox{
      position:fixed; inset:0; background:rgba(0,0,0,.65);
      display:flex; align-items:center; justify-content:center; z-index:1000;
    }
    .lightbox-inner{
      position:relative; max-width:92vw; max-height:92vh;
      display:flex; flex-direction:column; gap:8px; align-items:center;
      animation: lbIn .14s ease-out;
    }
    @keyframes lbIn{ from{ transform:scale(.98); opacity:0; } to{ transform:scale(1); opacity:1; } }
    .lightbox-img{
      max-width:92vw; max-height:86vh; border-radius:16px; display:block;
      box-shadow:0 8px 28px rgba(0,0,0,.35); background:#111;
    }
    .lightbox-title{ color:#fff; font-weight:700; text-shadow:0 1px 2px rgba(0,0,0,.4); }
    .lightbox-close{
      position:absolute; top:-12px; right:-12px; width:36px; height:36px; border-radius:50%;
      border:none; background:#fff; color:#333; cursor:pointer; font-size:1rem; font-weight:900;
      box-shadow:0 4px 16px rgba(0,0,0,.3);
    }
    .lightbox-close:hover{ background:#FF93C2; color:#fff; }
  </style>
</head>
<body id="top">
  <div class="container">
    <a href="index.html" class="backlink">← indexに戻る</a>

    <img src="rxd-logo.png" class="logoimg" alt="RxDロゴ">
    <h1>画像お題</h1>
    <hr class="cute">
    <p class="desc">相方AIと楽しむ画像お題。<br>改変推奨 / 報告不要 / 全て自由💋</p>
    <hr class="cute">

    <div class="cards" id="cards"><div style="opacity:.6">読み込み中…</div></div>

    <a href="index.html" class="backlink">← indexに戻る</a>
    <div class="footer">&copy; 2025 Secret Base (Rag and Duster)</div>
  </div>

  <!-- ライトボックス -->
  <div id="lightbox" class="lightbox" hidden role="dialog" aria-modal="true" aria-label="画像プレビュー">
    <div class="lightbox-inner" role="document">
      <img class="lightbox-img" alt="">
      <div class="lightbox-title"></div>
      <button class="lightbox-close" aria-label="閉じる">×</button>
    </div>
  </div>

  <script>
    // --- util ---
    async function copyPrompt(id, btn){
      const el = document.getElementById(id);
      const text = (el?.value ?? el?.textContent ?? '').trim();
      if(!text) return;
      try{
        if(navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
        }else{
          const r=document.createRange(); r.selectNodeContents(el);
          const s=window.getSelection(); s.removeAllRanges(); s.addRange(r);
          document.execCommand('copy'); s.removeAllRanges();
        }
        flash(btn,'こぴした！');
      }catch{ flash(btn,'失敗？'); }
    }
    function flash(btn, msg, t=1600){
      const o=btn.textContent; btn.textContent=msg; btn.disabled=true;
      setTimeout(()=>{ btn.textContent=o; btn.disabled=false; }, t);
    }
    function cardUrl(id){ return `${location.origin}${location.pathname}#${encodeURIComponent(id)}`; }
    async function copyUrl(id, btn){
      try{ await navigator.clipboard.writeText(cardUrl(id)); flash(btn,'urlこぴした！'); }
      catch{ flash(btn,'失敗？'); }
    }

    // スマホは同一タブ twitter.com、PCは別タブ x.com
    function shareToX(id, title){
      const text = `【お題】${title || humanizeId(id)}\n${location.origin}${location.pathname}#${encodeURIComponent(id)}`;
      const isMobile = /iPhone|iPad|iPod|Android|Mobile/i.test(navigator.userAgent);
      const webMobile  = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}`;
      const webDesktop = `https://x.com/intent/post?text=${encodeURIComponent(text)}`;
      if (isMobile) location.href = webMobile;
      else window.open(webDesktop, '_blank', 'noopener,width=640,height=520');
    }

    // OS共有（無ければURLをコピー）
    async function shareSystem(id, title, btn){
      const text = `【お題】${title || humanizeId(id)}\n${cardUrl(id)}`;
      if(navigator.share){
        try{ await navigator.share({ text }); return; }catch{}
      }
      try{ await navigator.clipboard.writeText(text); flash(btn,'copy!'); }
      catch{ window.open(cardUrl(id),'_blank'); }
    }

    // 拡張子レースで最速ヒットを返す（並列）
    async function resolveImageSrc(id){
      const exts = ['.webp','.jpg','.jpeg','.png']; // 速そうな順
      const trials = exts.map(ext=>{
        const url = `image_prompt/${id}${ext}`;
        return fetch(url, {method:'HEAD', cache:'no-store'})
          .then(r=> r.ok ? url : Promise.reject());
      });
      try{ return await Promise.any(trials); }
      catch{ return null; }
    }

    function humanizeId(id){
      return id.replace(/[_-]+/g,' ').replace(/\s+/g,' ').trim().replace(/^./, s=>s.toUpperCase());
    }

    // --- hash focus ---
    function setTargetCardClass(){
      document.querySelectorAll('.card.is-target').forEach(c=>c.classList.remove('is-target'));
      if(!location.hash) return;
      const id = decodeURIComponent(location.hash.slice(1));
      const el = document.getElementById(id);
      if(el) el.classList.add('is-target');
    }
    function focusCardByHash(behavior='smooth'){
      setTargetCardClass();
      if(!location.hash) return;
      const id = decodeURIComponent(location.hash.slice(1));
      const el = document.getElementById(id);
      if(!el) return;
      el.scrollIntoView({behavior, block:'center'});
      el.classList.add('highlight');
      setTimeout(()=> el.classList.remove('highlight'), 2000);
    }
    window.addEventListener('hashchange', ()=> focusCardByHash('smooth'));

    // --- lightbox ---
    const lb = document.getElementById('lightbox');
    const lbImg = lb.querySelector('.lightbox-img');
    const lbTitle = lb.querySelector('.lightbox-title');
    const lbClose = lb.querySelector('.lightbox-close');
    let lastFocus = null;

    function openLightbox(src, alt, title){
      if(!src) return;
      lastFocus = document.activeElement;
      lbImg.src = src; lbImg.alt = alt || '';
      lbTitle.textContent = title || '';
      lb.hidden = false; document.body.style.overflow = 'hidden'; lbClose.focus();
    }
    function closeLightbox(){
      lb.hidden = true; lbImg.src = '';
      document.body.style.overflow = '';
      if(lastFocus && typeof lastFocus.focus === 'function'){ lastFocus.focus(); }
    }
    lb.addEventListener('click', (e)=>{ if(e.target === lb) closeLightbox(); });
    lbClose.addEventListener('click', closeLightbox);
    document.addEventListener('keydown', (e)=>{ if(!lb.hidden && e.key === 'Escape') closeLightbox(); });

    // --- build cards（カード→即描画 / 画像→並列で後付け） ---
    async function buildCards(){
      const wrap = document.getElementById('cards');
      if(!wrap) return;

      try{
        const res = await fetch('image_prompt/00caption.txt', {cache:'no-store'});
        if(!res.ok) throw new Error('HTTP '+res.status);
        const text = await res.text();

        const lines = text.split(/\r?\n/)
          .map(s=>s.trim())
          .filter(s => s && !s.startsWith('#') && !s.startsWith('//'));

        wrap.innerHTML = '';

        for(const line of lines){
          const parts = line.split('<>');
          const id = (parts[0]||'').trim();
          if(!id) continue;

          // 2カラム: id<>説明 / 3カラム: id<>タイトル<>説明
          const hasThree = parts.length >= 3;
          const title = hasThree ? (parts[1]||'').trim() : humanizeId(id);
          const desc  = hasThree ? (parts[2]||'').trim() : (parts[1]||'').trim();

          const card = document.createElement('div');
          card.className = 'card';
          card.id = id;

          const gotop = document.createElement('a');
          gotop.href = '#top'; gotop.className = 'gotop'; gotop.textContent = '▲';

          /* 画像側：共有バー→サムネ（縦） */
          const media = document.createElement('div');
          media.className = 'media';

          const share = document.createElement('div');
          share.className = 'sharebar';

          const btnUrl = document.createElement('button');
          btnUrl.type='button'; btnUrl.className = 'sharebtn urlbtn'; btnUrl.textContent = 'url';
          btnUrl.addEventListener('click', ()=> copyUrl(id, btnUrl));
          share.appendChild(btnUrl);

          const btnX = document.createElement('button');
          btnX.type='button'; btnX.className = 'sharebtn xbtn'; btnX.textContent = 'X';
          btnX.title = 'Xでポスト';
          btnX.addEventListener('click', ()=> shareToX(id, title || humanizeId(id)));
          share.appendChild(btnX);

          const btnSys = document.createElement('button');
          btnSys.type='button'; btnSys.className = 'sharebtn sysbtn'; btnSys.textContent = '🔗';
          btnSys.title = '共有（OSの共有UI）';
          btnSys.addEventListener('click', ()=> shareSystem(id, title || humanizeId(id), btnSys));
          share.appendChild(btnSys);

          const img = document.createElement('img');
          img.className = 'thumb skel';          // ← 骨組み表示を先に出す
          img.alt = `${title} sample`;
          img.loading = 'lazy'; img.decoding = 'async'; img.tabIndex = 0;

          media.appendChild(share);
          media.appendChild(img);

          const body = document.createElement('div'); body.className = 'cardbody';
          const ttl = document.createElement('div'); ttl.className = 'cardtitle'; ttl.textContent = title || humanizeId(id);
          const dsc = document.createElement('div'); dsc.className = 'carddesc'; dsc.textContent = desc || '';

          const pbox = document.createElement('div'); pbox.className = 'promptbox';
          const ta = document.createElement('textarea');
          ta.className = 'promptarea'; ta.rows = 1; ta.wrap = 'off'; ta.readOnly = true; ta.id = `prompt-${id}`;
          const btnCopy = document.createElement('button');
          btnCopy.type='button'; btnCopy.className = 'copybtn'; btnCopy.textContent = 'コピー';
          btnCopy.addEventListener('click', ()=>copyPrompt(ta.id, btnCopy));

          pbox.appendChild(ta); pbox.appendChild(btnCopy);
          body.appendChild(ttl); body.appendChild(dsc); body.appendChild(pbox);

          card.appendChild(gotop);
          card.appendChild(media);   /* ← 共有バー + 画像（縦） */
          card.appendChild(body);
          wrap.appendChild(card);

          // テキスト読み込み（非待機）
          fetch(`image_prompt/${id}.txt`, {cache:'no-store'})
            .then(r=>r.ok?r.text():'')
            .then(t=>{ ta.value = t || '(読み込み失敗)'; })
            .catch(()=>{ ta.value='(読み込み失敗)'; });

          // 画像解決（非待機・並列）→結果で差し替え
          resolveImageSrc(id).then(src=>{
            img.classList.remove('skel');
            if(src){
              img.src = src;
              const open = ()=> openLightbox(src, img.alt, title);
              img.addEventListener('click', open);
              img.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); open(); }});
            }else{
              const ph = document.createElement('div');
              ph.className = 'thumb ph'; ph.textContent = 'no img';
              media.replaceChild(ph, img);
            }
          });
        }

        if(!wrap.children.length){
          wrap.innerHTML = '<div style="opacity:.6">（お題がありません）</div>';
        }

        // 生成が完了したタイミングでハッシュへジャンプ＆強調（1回だけ）
        requestAnimationFrame(()=> focusCardByHash('auto'));
        setTimeout(()=> focusCardByHash('auto'), 150);

      }catch(e){
        wrap.innerHTML = '<div style="opacity:.7">読み込み失敗… '+(e.message||e)+'</div>';
      }
    }

    window.addEventListener('DOMContentLoaded', buildCards);
  </script>
</body>
</html>
